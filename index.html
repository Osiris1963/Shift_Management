<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Management Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Poppins font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
            overscroll-behavior: none;
        }
        
        /* McDonald's Colors */
        .mcd-red { background-color: #c00000; }
        .mcd-text-red { color: #c00000; }
        .mcd-yellow { background-color: #ffc72c; }
        .mcd-green { color: #22c55e; }
        .mcd-gray { color: #9ca3af; }
        
        /* Active Tab Style */
        .active-tab {
            background-color: transparent;
            color: #c00000; /* mcd-red */
            font-weight: 700; /* bold */
            border-bottom: 3px solid #c00000;
            box-shadow: none;
        }
        /* Inactive Tab Style */
        .tab-btn {
            background-color: transparent;
            color: #4b5563; /* gray-600 */
            font-weight: 600; /* semibold */
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            font-size: 0.9rem;
            letter-spacing: 0.025em;
            border-bottom: 3px solid transparent;
            padding: 1rem;
            white-space: nowrap;
        }
        .tab-btn:hover {
            background-color: #f9fafb; /* gray-50 */
            color: #111827; /* gray-900 */
        }
        
        /* Custom Accordion */
        .accordion-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: #f9fafb;
        }
        
        /* Sub-Tab Styles */
        .sub-tab-btn {
            background-color: #f9fafb;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .sub-tab-btn:hover {
            background-color: #fefce8;
            color: #4b5563;
        }
        .active-sub-tab {
            background-color: white;
            color: #c00000;
            border-bottom-color: #c00000;
            font-weight: 600;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 1.5rem;
        }
        /* Class for opening accordion via JS */
        .accordion-content.open {
            max-height: 10000px;
            padding: 1.5rem;
        }
        .accordion-arrow {
            transition: transform 0.3s;
        }
        .accordion-arrow.open {
            transform: rotate(180deg);
        }

        /* Task Item */
        .task-item {
            border-bottom: 1px solid #e5e7eb;
        }
        .task-item:last-child {
            border-bottom: none;
        }
        
        /* Custom Checkbox */
        .task-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #9ca3af;
            border-radius: 0.25rem;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .task-checkbox:checked {
            background-color: #c00000;
            border-color: #c00000;
        }
        .task-checkbox:checked::after {
            content: '‚úî';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            line-height: 1;
        }
        
        /* Notes Input */
        .task-notes:focus,
        .dashboard-input:focus {
            border-color: #ffc72c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 199, 44, 0.4);
        }
        
        /* Reminder Modal */
        #reminder-modal-bg,
        #ai-loading-modal-bg,
        #ai-result-modal-bg,
        #finalize-modal-bg {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        #reminder-modal,
        #ai-loading-modal,
        #ai-result-modal,
        #finalize-modal {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        /* Alert/Notification */
        #alert-box {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        /* Custom switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #c00000;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #c00000;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Sticky Tab Header */
        #tab-header {
            position: sticky;
            top: 0;
            background-color: #f3f4f6; /* Match body bg */
            z-index: 10; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            overflow-x: auto; /* Allow scrolling on small screens */
        }

        /* Target Grid Styles */
        .target-header-grid {
            display: none; /* Hide header on mobile */
        }
        .target-row {
            grid-template-columns: 1fr 1fr; /* 2 cols for inputs */
        }
        .target-row-label {
            grid-column: 1 / -1; /* Label spans full width */
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .target-row-diff {
            grid-column: 1 / -1; /* Diff spans full width */
            text-align: center;
            font-weight: 600;
            padding-top: 0.25rem;
            margin-top: 0.25rem;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Desktop override for targets */
        @media (min-width: 768px) {
            .target-header-grid {
                display: grid; /* Show header on desktop */
                grid-template-columns: repeat(4, 1fr);
            }
             .target-row {
                grid-template-columns: repeat(4, 1fr); /* 4 cols on desktop */
            }
            .target-row-label {
                grid-column: auto; /* Reset span */
                margin-bottom: 0;
            }
            .target-row-diff {
                grid-column: auto; /* Reset span */
                text-align: center;
                border-top: none;
                margin-top: 0;
                padding-top: 0;
            }
        }
        
        /* Leaderboard Styles */
        .rank-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .rank-1 { background-color: #FFD700; color: white; }
        .rank-2 { background-color: #C0C0C0; color: white; }
        .rank-3 { background-color: #CD7F32; color: white; }
        .rank-other { background-color: #F3F4F6; color: #6B7280; }

    </style>
</head>
<body class="h-full flex flex-col">
    
    <!-- Main Content Container -->
    <main id="main-content" class="flex-1 h-full overflow-y-auto">
        <div class="max-w-7xl mx-auto p-4 md:p-8">
            
            <h1 class="text-3xl md:text-4xl font-extrabold mcd-text-red mb-6 text-center md:text-left">Shift Management Tool</h1>
            
            <!-- Tab Navigation -->
            <nav id="tab-header" class="bg-white rounded-xl shadow-lg mb-6 flex">
                <button class="tab-btn flex-grow text-center flex items-center justify-center" data-tab="leaderboard">
                    <span class="mr-2">üèÜ</span> Leaderboard
                </button>
                <button class="tab-btn flex-grow text-center" data-tab="shift-plans">
                    1. Shift Plans
                </button>
                <button class="tab-btn flex-grow text-center" data-tab="shift-targets">
                    2. Shift Targets
                </button>
                <button class="tab-btn flex-grow text-center" data-tab="pre-shift">
                    3. Pre-Shift
                </button>
                <button class="tab-btn flex-grow text-center" data-tab="during-shift">
                    4. During Shift
                </button>
                <button class="tab-btn flex-grow text-center" data-tab="travel-path">
                    5. Travel Path
                </button>
                <button class="tab-btn flex-grow text-center" data-tab="post-shift">
                    6. Post-Shift
                </button>
            </nav>

            <!-- Tab Content Area -->
            
            <!-- 0. Leaderboard Tab -->
            <div id="tab-leaderboard" class="tab-content hidden">
                <!-- Current Shift Score Card -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl shadow-sm p-6 mb-6 flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-xl font-bold text-gray-900" id="current-score-title">Your Current Shift Score</h3>
                        <p class="text-sm text-gray-600">Score based on Targets Met and Checklist Completion.</p>
                        
                        <!-- Updated Metrics List -->
                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1 text-sm text-gray-600">
                            <p>‚Ä¢ Sales (Actual ‚â• Target): <span class="font-bold text-green-600">+15 pts</span></p>
                            <p>‚Ä¢ OEPE (Actual ‚â§ Target): <span class="font-bold text-green-600">+15 pts</span></p>
                            <p>‚Ä¢ GC (Actual ‚â• Target): <span class="font-bold text-green-600">+10 pts</span></p>
                            <p>‚Ä¢ AC (Actual ‚â• Target): <span class="font-bold text-green-600">+10 pts</span></p>
                            <p>‚Ä¢ RW (Actual ‚â§ Target): <span class="font-bold text-green-600">+10 pts</span></p>
                            <p>‚Ä¢ R2P (Actual ‚â§ Target): <span class="font-bold text-green-600">+10 pts</span></p>
                            <p>‚Ä¢ CFS (Actual ‚â• Target): <span class="font-bold text-green-600">+10 pts</span></p>
                            <p>‚Ä¢ Checklists (100%): <span class="font-bold text-green-600">+20 pts</span></p>
                        </div>
                    </div>
                    <div class="text-center">
                        <span id="current-shift-score" class="text-5xl font-extrabold mcd-text-red">0</span>
                        <p class="text-xs text-gray-500 uppercase tracking-wider mt-1">Total Points</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mcd-text-red">Manager Leaderboard</h2>
                            <p class="text-sm text-gray-500">Ranking based on accumulated Average Score</p>
                        </div>
                        <button id="refresh-leaderboard-btn" class="text-sm text-gray-500 hover:text-gray-800 underline">
                            Refresh Data
                        </button>
                    </div>

                    <!-- Leaderboard Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs text-gray-500 uppercase border-b border-gray-100">
                                    <th class="py-3 px-4 font-semibold">Rank</th>
                                    <th class="py-3 px-4 font-semibold">Manager</th>
                                    <th class="py-3 px-4 font-semibold text-center">Avg Score</th>
                                    <th class="py-3 px-4 font-semibold text-center">Sales Hit Rate</th>
                                    <th class="py-3 px-4 font-semibold text-center">OEPE Hit Rate</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body" class="text-sm text-gray-700">
                                <!-- Content populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 1. Shift Plans Tab -->
            <div id="tab-shift-plans" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mcd-text-red mb-6">Shift Plans & Details</h2>

                    <!-- Section: Shift Details (Input) -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Current Shift Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="shift-date" data-save="shift-date" class="p-3 border border-gray-300 rounded-lg dashboard-input w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Shift Leader</label>
                                <input type="text" id="shift-leader" data-save="shift-leader" placeholder="Shift Leader Name" class="p-3 border border-gray-300 rounded-lg dashboard-input w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Shift Time</label>
                                <select id="shift-time" data-save="shift-time" class="p-3 border border-gray-300 rounded-lg dashboard-input w-full text-gray-500">
                                    <option value="" disabled selected>Select Shift</option>
                                    <option value="opening">Opening</option>
                                    <option value="mid">Mid-Shift</option>
                                    <option value="closing">Closing</option>
                                    <option value="graveyard">Graveyard Shift</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <hr class="my-8 border-gray-200">
                    
                    <!-- Section: Save Plan -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Save This Plan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div>
                                <label for="plan-name-input" class="block text-sm font-medium text-gray-700 mb-1">Plan Name</label>
                                <input type="text" id="plan-name-input" placeholder="e.g., Opening Shift - John" class="p-3 border border-gray-300 rounded-lg dashboard-input w-full">
                            </div>
                            <button id="save-plan-btn" class="mcd-red hover:bg-red-800 text-white font-semibold py-3 px-4 rounded-lg shadow-md w-full h-12">
                                Save Current Plan
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">This will save all data currently entered in the tool (Targets, Checklists, Notes). <br><span class="text-mcd-red font-bold">Note:</span> Saved plans are drafts and do NOT appear in the leaderboard until finalized via "Generate Handover Summary".</p>
                    </div>
                    
                    <hr class="my-8 border-gray-200">

                    <!-- Section: Load Plan -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Load Previous Plan</h3>
                        
                        <div class="flex flex-col space-y-4">
                            <!-- Date Search -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                <div>
                                    <label for="plan-date-input" class="block text-sm font-medium text-gray-700 mb-1">Search by Date</label>
                                    <input type="date" id="plan-date-input" class="p-3 border border-gray-300 rounded-lg dashboard-input w-full">
                                </div>
                                <button id="find-plans-btn" class="mcd-yellow hover:bg-yellow-500 text-gray-900 font-semibold py-3 px-4 rounded-lg shadow-md w-full h-12">
                                    Find Plans
                                </button>
                            </div>

                            <!-- Show All Option -->
                            <div class="border-t border-gray-100 pt-4">
                                <button id="find-all-plans-btn" class="text-sm text-gray-500 hover:text-gray-800 underline flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                    </svg>
                                    Show all recent plans instead
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Area -->
                        <div id="plan-results-container" class="mt-6">
                            <p id="plan-results-status" class="text-gray-500">Select a date or click "Show all" to find plans.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Shift Targets Tab -->
            <div id="tab-shift-targets" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mcd-text-red mb-6">Shift Targets & Performance</h2>
                    
                    <!-- Responsive Grid for Targets -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8">
                        <!-- Sales/Profit Column -->
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-3">Sales / Profit</h3>
                            <div class="target-header-grid gap-2 items-center mb-2 font-medium text-gray-600 text-sm">
                                <span>Metric</span>
                                <span>Target</span>
                                <span>Actual</span>
                                <span>+/-</span>
                            </div>
                            <!-- Target Rows -->
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-sales" class="target-row-label">Sales</label>
                                <input type="number" id="target-sales" data-save="target-sales" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-sales" data-save="actual-sales" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-sales" class="diff-output target-row-diff">0</span>
                            </div>
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-gc" class="target-row-label">GC</label>
                                <input type="number" id="target-gc" data-save="target-gc" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-gc" data-save="actual-gc" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-gc" class="diff-output target-row-diff">0</span>
                            </div>
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-ac" class="target-row-label">AC</label>
                                <input type="number" id="target-ac" data-save="target-ac" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-ac" data-save="actual-ac" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-ac" class="diff-output target-row-diff">0</span>
                            </div>
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-crew-labor" class="target-row-label">Crew Labor</label>
                                <input type="number" id="target-crew-labor" data-save="target-crew-labor" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-crew-labor" data-save="actual-crew-labor" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-crew-labor" class="diff-output target-row-diff">0</span>
                            </div>
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-rw" class="target-row-label">RW</label>
                                <input type="number" id="target-rw" data-save="target-rw" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-rw" data-save="actual-rw" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-rw" class="diff-output target-row-diff">0</span>
                            </div>
                        </div>
                        
                        <!-- Customer Experience Column -->
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-3">Customer Experience</h3>
                            <div class="target-header-grid gap-2 items-center mb-2 font-medium text-gray-600 text-sm">
                                <span>Metric</span>
                                <span>Target</span>
                                <span>Actual</span>
                                <span>+/-</span>
                            </div>
                            <!-- Target Rows -->
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-oepe" class="target-row-label">OEPE</label>
                                <!-- Preset: 120 -->
                                <input type="number" id="target-oepe" data-save="target-oepe" value="120" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-oepe" data-save="actual-oepe" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-oepe" class="diff-output target-row-diff">0</span>
                            </div>
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-opt" class="target-row-label">Order Prep</label>
                                <!-- Preset: 50 -->
                                <input type="number" id="target-opt" data-save="target-opt" value="50" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-opt" data-save="actual-opt" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-opt" class="diff-output target-row-diff">0</span>
                            </div>
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-r2p" class="target-row-label">R2P</label>
                                <!-- Preset: 90 -->
                                <input type="number" id="target-r2p" data-save="target-r2p" value="90" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-r2p" data-save="actual-r2p" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-r2p" class="diff-output target-row-diff">0</span>
                            </div>
                            <div class="target-row grid gap-2 items-center mb-3">
                                <label for="target-cfs" class="target-row-label">CFS</label>
                                <!-- Preset: 10 -->
                                <input type="number" id="target-cfs" data-save="target-cfs" value="10" class="target-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Target">
                                <input type="number" id="actual-cfs" data-save="actual-cfs" class="actual-input dashboard-input p-2 border border-gray-300 rounded-lg w-full" placeholder="Actual">
                                <span id="diff-cfs" class="diff-output target-row-diff">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- People & Other Tasks -->
                    <hr class="my-8 border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-3">People</h3>
                            <input type="text" id="people-names" data-save="people-names" placeholder="Names..." class="dashboard-input p-3 border border-gray-300 rounded-lg w-full mb-2">
                            <input type="text" id="people-actual" data-save="people-actual" placeholder="Actual..." class="dashboard-input p-3 border border-gray-300 rounded-lg w-full">
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-3">PM/BM Tasks</h3>
                            <input type="text" id="tasks-fusoc" data-save="tasks-fusoc" placeholder="FUSOC..." class="dashboard-input p-3 border border-gray-300 rounded-lg w-full mb-2">
                            <input type="text" id="tasks-prwr" data-save="tasks-prwr" placeholder="PR/WR..." class="dashboard-input p-3 border border-gray-300 rounded-lg w-full">
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-3">Others</h3>
                            <textarea id="tasks-others" data-save="tasks-others" placeholder="Notes..." class="dashboard-input p-3 border border-gray-300 rounded-lg w-full h-24"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- 3. Pre-Shift Tab -->
            <div id="tab-pre-shift" class="tab-content hidden">
                <!-- Accordion Controls -->
                <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-end space-x-3">
                    <button class="expand-all-btn text-sm font-medium mcd-text-red hover:underline">Expand All</button>
                    <button class="collapse-all-btn text-sm font-medium mcd-text-red hover:underline">Collapse All</button>
                </div>
                <div id="pre-shift-accordion-container">
                    <!-- Accordions will be injected here by JavaScript -->
                </div>
            </div>

            <!-- 4. During Shift Tab -->
            <div id="tab-during-shift" class="tab-content hidden">
                <!-- Accordion Controls -->
                <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-end space-x-3">
                    <button class="expand-all-btn text-sm font-medium mcd-text-red hover:underline">Expand All</button>
                    <button class="collapse-all-btn text-sm font-medium mcd-text-red hover:underline">Collapse All</button>
                </div>
                <div id="during-shift-accordion-container">
                    <!-- During Shift accordions will be injected here by JavaScript -->
                </div>
                
                <!-- Travel Path Focus List -->
                <div class="p-6 mt-6 border-t border-gray-200 bg-gray-50 rounded-lg">
                    <h2 class="text-2xl font-bold mcd-text-red mb-4">Travel Path Focus List</h2>
                    <p class="text-sm text-gray-600 mb-4">Click the button to refresh the list of outstanding items from your Pre-Shift checklist. This will show all unchecked tasks.</p>
                    <button id="refresh-travel-path-btn" class="mcd-yellow hover:bg-yellow-500 text-gray-900 font-semibold py-2 px-4 rounded-lg shadow-md mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -ml-1 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.004 10.043a1 1 0 01-.666 1.885 7.002 7.002 0 01-2.566-11.601 1 1 0 11.666 1.885 5.002 5.002 0 007 7H5a1 1 0 110-2h5.001a1 1 0 01.996 1.113z" clip-rule="evenodd" />
                        </svg>
                        Refresh Focus List
                    </button>
                    
                    <div id="travel-path-report-container">
                        <p class="text-gray-500">Click the "Refresh" button to generate your focus list.</p>
                    </div>
                </div>
            </div>

            <!-- 5. Travel Path Tab -->
            <div id="tab-travel-path" class="tab-content hidden">
                <!-- Travel Path Alarm -->
                <div class="p-6 border-b border-gray-200 bg-gray-50 rounded-lg mb-6">
                    <h2 class="text-2xl font-bold mcd-text-red mb-4">Travel Path Alarm</h2>
                    <div class="flex items-center justify-between">
                        <label for="travel-path-alarm-toggle" class="text-gray-700 font-medium text-lg">Enable 30-min Travel Path Reminder</label>
                        <label class="switch">
                            <input type="checkbox" id="travel-path-alarm-toggle" data-save="travel-path-alarm-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Sub-Tab Navigation -->
                <nav class="flex border-b border-gray-200">
                    <button class="sub-tab-btn flex-grow p-4 text-center font-medium" data-sub-tab="checklist">
                        Full Checklist
                    </button>
                    <button class="sub-tab-btn flex-grow p-4 text-center font-medium" data-sub-tab="todo">
                        To Do List
                    </button>
                </nav>

                <!-- Sub-Tab Content: Checklist -->
                <div id="sub-tab-checklist" class="sub-tab-content">
                    <!-- Accordion Controls -->
                    <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-end space-x-3">
                        <button class="expand-all-btn text-sm font-medium mcd-text-red hover:underline">Expand All</button>
                        <button class="collapse-all-btn text-sm font-medium mcd-text-red hover:underline">Collapse All</button>
                    </div>
                    <div id="travel-path-accordion-container">
                        <!-- Travel Path accordions will be injected here by JavaScript -->
                    </div>
                </div>

                <!-- Sub-Tab Content: To Do List -->
                <div id="sub-tab-todo" class="sub-tab-content hidden p-6">
                    <h2 class="text-2xl font-bold mcd-text-red mb-4">Travel Path To Do List</h2>
                    <p class="text-sm text-gray-600 mb-4">Click the button to refresh the list of outstanding items from your Travel Path checklist. This will show all unchecked tasks.</p>
                    <button id="refresh-travel-path-todo-btn" class="mcd-yellow hover:bg-yellow-500 text-gray-900 font-semibold py-2 px-4 rounded-lg shadow-md mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -ml-1 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.004 10.043a1 1 0 01-.666 1.885 7.002 7.002 0 01-2.566-11.601 1 1 0 11.666 1.885 5.002 5.002 0 007 7H5a1 1 0 110-2h5.001a1 1 0 01.996 1.113z" clip-rule="evenodd" />
                        </svg>
                        Refresh To Do List
                    </button>
                    
                    <div id="travel-path-todo-list-container">
                        <p class="text-gray-500">Click the "Refresh" button to generate your to-do list.</p>
                    </div>
                </div>
            </div>

            <!-- 6. Post-Shift Tab -->
            <div id="tab-post-shift" class="tab-content hidden">
                <!-- Accordion Controls -->
                <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-end space-x-3">
                    <button class="expand-all-btn text-sm font-medium mcd-text-red hover:underline">Expand All</button>
                    <button class="collapse-all-btn text-sm font-medium mcd-text-red hover:underline">Collapse All</button>
                </div>
                <div id="post-shift-accordion-container">
                    <!-- Post-Shift accordions will be injected here by JavaScript -->
                </div>

                <!-- AI Handover -->
                <div class="p-6 mt-6 border-t border-gray-200 bg-gray-50 rounded-lg">
                    <h2 class="text-2xl font-bold mcd-text-red mb-4">AI Handover Summary</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Click the button to generate a complete handover summary. This will also automatically save your shift data and update your leaderboard ranking.
                    </p>
                    <button id="generate-summary-btn" class="mcd-red hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md">
                        Generate Handover Summary
                    </button>
                </div>
            </div>

        </div>
    </main>
    
    <!-- Reminder Modal -->
    <div id="reminder-modal-bg" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-40 opacity-0">
        <div id="reminder-modal" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0">
            <h3 class="text-xl font-bold mcd-text-red mb-4">Set Reminder</h3>
            <p id="reminder-task-name" class="text-gray-700 mb-4"></p>
            <label for="reminder-time" class="block text-sm font-medium text-gray-700 mb-2">Remind me in (minutes):</label>
            <input type="number" id="reminder-time" value="15" class="p-3 border border-gray-300 rounded-lg w-full mb-4">
            <div class="flex justify-end space-x-3">
                <button id="cancel-reminder-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md">Cancel</button>
                <button id="set-reminder-btn" class="mcd-red hover:bg-red-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Set</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Finalization Modal -->
    <div id="finalize-modal-bg" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 opacity-0">
        <div id="finalize-modal" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold mcd-text-red">Finalize Shift Handover</h3>
                <button id="close-finalize-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Please confirm your details to generate the handover summary and update the leaderboard.</p>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift Leader Name</label>
                    <input type="text" id="finalize-name" class="p-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none" placeholder="Enter your name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift Date</label>
                    <input type="date" id="finalize-date" class="p-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none">
                </div>
            </div>
            
            <button id="continue-summary-btn" class="w-full mcd-red hover:bg-red-800 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                Continue & Generate Summary
            </button>
        </div>
    </div>

    <!-- Alert Box -->
    <div id="alert-box" class="fixed bottom-0 right-0 m-8 bg-white rounded-lg shadow-xl p-6 w-full max-w-sm border-l-4 border-yellow-400 z-50 transform translate-x-full opacity-0">
        <div class="flex items-start">
            <div class="flex-shrink-0 pt-0.5">
                <svg class="h-8 w-8 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                </svg>
            </div>
            <div class="ml-4 w-0 flex-1">
                <h3 class="text-lg font-bold mcd-text-red">Reminder!</h3>
                <p id="alert-message" class="mt-1 text-gray-700"></p>
                <button id="acknowledge-alert-btn" class="mt-4 mcd-yellow hover:bg-yellow-500 text-gray-900 font-semibold py-2 px-4 rounded-lg shadow-md">Acknowledge</button>
            </div>
        </div>
    </div>

    <!-- AI Loading Modal -->
    <div id="ai-loading-modal-bg" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 opacity-0">
        <div id="ai-loading-modal" class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md transform scale-95 opacity-0 text-center">
            <h3 class="text-xl font-bold mcd-text-red mb-4">Generating Summary</h3>
            <p class="text-gray-700 mb-6">Saving your data and analyzing shift...</p>
            <!-- Simple spinner -->
            <div class="flex justify-center items-center">
                <div class="w-12 h-12 border-4 border-t-4 border-gray-200 border-t-yellow-400 rounded-full animate-spin"></div>
            </div>
        </div>
    </div>

    <!-- AI Result Modal -->
    <div id="ai-result-modal-bg" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 opacity-0">
        <div id="ai-result-modal" class="bg-white rounded-lg shadow-xl p-0 w-full max-w-lg transform scale-95 opacity-0 flex flex-col" style="max-height: 90vh;">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold mcd-text-red">AI Handover Summary</h3>
                <button id="close-ai-result-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Modal Body (Scrollable) -->
            <div class="p-6 flex-1 overflow-y-auto">
                <pre id="ai-summary-output" class="text-gray-800 whitespace-pre-wrap" style="font-family: 'Poppins', sans-serif; font-size: 0.95rem; line-height: 1.6;"></pre>
            </div>
            <!-- Modal Footer -->
            <div class="flex justify-end space-x-3 p-6 bg-gray-50 border-t border-gray-200">
                <button id="copy-summary-btn" class="mcd-yellow hover:bg-yellow-500 text-gray-900 font-semibold py-2 px-4 rounded-lg shadow-md">Copy to Clipboard</button>
                <button id="close-ai-result-btn-2" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            limit,
            orderBy,
            getDocs,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (DIRECT CONNECTION) ---
        // Forced to use your specific project config always
        const firebaseConfig = {
          apiKey: "AIzaSyBlbxhzUp_TZd8oTrLxrY-E6gq-_XdiMCo",
          authDomain: "mcdonalds-san-carlos.firebaseapp.com",
          projectId: "mcdonalds-san-carlos",
          storageBucket: "mcdonalds-san-carlos.firebasestorage.app",
          messagingSenderId: "1052052612983",
          appId: "1:1052052612983:web:0e107aa9b6aadad3666372",
          measurementId: "G-QTSC1B9PD5"
        };
        
        // --- GEMINI AI API KEY ---
        const apiKey = "";
        
        // --- Global App State ---
        let app, db, auth;
        let userId = 'anonymous';
        let isAuthReady = false;
        let currentDocId = null; // Track the current Firestore doc ID
        
        // --- Data Persistence Keys ---
        const localSettingsKey = 'shiftAppLocalSettings';

        // --- Shift Plan Elements ---
        const savePlanBtn = document.getElementById('save-plan-btn');
        const planNameInput = document.getElementById('plan-name-input');
        
        // --- INIT FLAGS ---
        let isListenersInitialized = false;

        // --- Firestore Shift Plans ---
        function initShiftPlans() {
            if (!isAuthReady || !db) return; 
            
            // Guard clause: prevent double listeners
            if(isListenersInitialized) return;

            // DIRECT PATH: Root 'shift_plans' collection
            const plansCollection = collection(db, 'shift_plans');

            // 1. Save Current Plan
            if (savePlanBtn) {
                savePlanBtn.addEventListener('click', async () => {
                    // Call dedicated save function (DRAFT)
                    const success = await saveShiftData(false);
                    if (success) {
                        const statusEl = document.getElementById('plan-results-status');
                        if(statusEl) statusEl.textContent = `Successfully saved draft!`;
                        if(document.getElementById('plan-results-container')) document.getElementById('plan-results-container').innerHTML = '';
                    }
                });
            }

            // 2. Calendar-based Plan Finder
            const findPlansBtn = document.getElementById('find-plans-btn');
            const findAllPlansBtn = document.getElementById('find-all-plans-btn');
            const planDateInput = document.getElementById('plan-date-input');
            const planResultsContainer = document.getElementById('plan-results-container');
            const planResultsStatus = document.getElementById('plan-results-status');

            if (findPlansBtn) {
                findPlansBtn.addEventListener('click', async () => {
                    const selectedDate = planDateInput.value;
                    if (!selectedDate) {
                        planResultsStatus.textContent = 'Please select a date first.';
                        return;
                    }
                    performSearch(plansCollection, planResultsStatus, planResultsContainer, selectedDate);
                });
            }
            
            if (findAllPlansBtn) {
                findAllPlansBtn.addEventListener('click', async () => {
                    performSearch(plansCollection, planResultsStatus, planResultsContainer, null);
                });
            }

            // 3. Event listener for the dynamically created "Load" buttons
            if (planResultsContainer) {
                planResultsContainer.addEventListener('click', async (e) => {
                    const loadButton = e.target.closest('.load-plan-btn');
                    if (!loadButton) return; // Didn't click a load button

                    const docId = loadButton.dataset.docId;
                    if (!docId) return;

                    // Add loading state to button
                    loadButton.innerHTML = '<span>Loading...</span>';
                    loadButton.disabled = true;

                    try {
                        // DIRECT PATH
                        const docRef = doc(db, 'shift_plans', docId);
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists()) {
                            const loadedData = docSnap.data().data;
                            currentDocId = docId; // Set currentDocId so subsequent saves update this doc

                            populateFormWithData(loadedData); 
                            showTab(localStorage.getItem('activeTab') || 'pre-shift');
                            
                            // Remove all results after loading
                            planResultsContainer.innerHTML = '';
                            planResultsStatus.textContent = `Successfully loaded "${docSnap.data().name}".`;
                            
                            // Recalc score
                            updateCurrentShiftScore();

                        } else {
                            console.warn("Selected plan not found.");
                            planResultsStatus.textContent = 'Error: That plan could not be found.';
                        }
                    } catch (error) {
                        console.error("Error loading plan:", error);
                        planResultsStatus.textContent = 'An error occurred while loading the plan.';
                        loadButton.innerHTML = '<span>Error</span>';
                    }
                });
            }
            
            isListenersInitialized = true;
        }
        
        async function performSearch(collectionRef, statusEl, containerEl, dateFilter) {
            // Guard clause for auth
            if (!auth.currentUser) {
                // IMPROVED ERROR HANDLING:
                // If we are 'ready' but have no user, it means auth failed (likely disabled in console)
                if (isAuthReady) {
                     statusEl.innerHTML = `<span class="text-red-600 font-bold">Authentication Error:</span><br>
                     Could not sign in. Please ensure <strong>Anonymous Auth</strong> is enabled in the Firebase Console.<br>
                     (Build > Authentication > Sign-in method > Anonymous)`;
                } else {
                    statusEl.textContent = 'Waiting for authentication... (Initializing)';
                }
                return;
            }
            
            statusEl.textContent = dateFilter ? `Searching for plans on ${dateFilter}...` : 'Loading recent plans...';
            containerEl.innerHTML = ''; // Clear old results

            try {
                let q;
                if (dateFilter) {
                    q = query(collectionRef, where("shiftDate", "==", dateFilter));
                } else {
                    q = query(collectionRef, limit(10));
                }
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    statusEl.textContent = dateFilter 
                        ? `No plans found for ${dateFilter}.` 
                        : `No saved plans found yet.`;
                    return;
                }

                statusEl.textContent = `Found ${querySnapshot.size} plan(s):`;
                
                let plansHtml = '<div class="flex flex-col space-y-2">';
                querySnapshot.forEach((doc) => {
                    const plan = doc.data();
                    let dateDisplay = plan.shiftDate || 'No Date';
                    let statusBadge = plan.status === 'completed' 
                        ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded font-bold ml-2">Finalized</span>' 
                        : '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded font-bold ml-2">Draft</span>';
                    
                    plansHtml += `
                        <button class="load-plan-btn text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg flex justify-between items-center border border-gray-200 transition-colors" data-doc-id="${doc.id}">
                            <span>
                                <span class="font-semibold text-gray-800 block">${plan.name} ${statusBadge}</span>
                                <span class="text-xs text-gray-500 block">
                                    <span class="font-medium text-gray-700">${dateDisplay}</span> ‚Ä¢ 
                                    By ${plan.author || 'Manager'}
                                </span>
                            </span>
                            <span class="text-sm font-bold mcd-text-red bg-white px-3 py-1 rounded border border-gray-200 shadow-sm">Load</span>
                        </button>
                    `;
                });
                plansHtml += '</div>';
                containerEl.innerHTML = plansHtml;

            } catch (error) {
                console.error("Error finding plans:", error);
                statusEl.textContent = 'Error: ' + error.message;
            }
        }

        // Reusable Save Function (with Update Logic)
        async function saveShiftData(isFinal = false, retryCount = 0) {
            if (!isAuthReady || !db) return false;
            if (!auth.currentUser) {
                console.warn("Cannot save: User not authenticated yet.");
                return false;
            }
            
            const saveBtn = document.getElementById('save-plan-btn');
            if(saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
            }
            
            const planNameInput = document.getElementById('plan-name-input');
            const shiftLeaderInput = document.getElementById('shift-leader'); 
            const shiftDateInput = document.getElementById('shift-date');     

            const planName = planNameInput.value.trim();
            const shiftDate = shiftDateInput.value;
            const shiftLeader = shiftLeaderInput.value.trim();

            // Basic Validation
            if (!planName) {
                // Auto-generate plan name if empty but we have details
                if(shiftDate && shiftLeader) {
                    planNameInput.value = `${shiftLeader} - ${shiftDate}`;
                } else {
                    console.warn("Please enter a plan name.");
                    planNameInput.classList.add('border-red-500');
                    setTimeout(() => planNameInput.classList.remove('border-red-500'), 2000);
                    if(saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save Current Plan';
                    }
                    return false;
                }
            }
            
            if (!shiftDate) {
                console.warn("Please set a Shift Date.");
                shiftDateInput.classList.add('border-red-500');
                setTimeout(() => shiftDateInput.classList.remove('border-red-500'), 2000);
                 if(saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Current Plan';
                }
                return false;
            }

            const currentData = scrapeDataFromForm();
            const author = shiftLeader || 'Manager';
            const status = isFinal ? 'completed' : 'draft';
            
            try {
                // DIRECT PATH
                const plansCollection = collection(db, 'shift_plans');
                
                if (currentDocId) {
                    // Update existing document
                    const docRef = doc(db, 'shift_plans', currentDocId);
                    await updateDoc(docRef, {
                        name: planNameInput.value,
                        author: author,
                        shiftDate: shiftDate,
                        status: status, 
                        data: currentData,
                        updatedAt: serverTimestamp()
                    });
                    console.log(`%c[SAVE SUCCESS] Updated existing shift: ${currentDocId}`, "color: green; font-weight: bold;");
                } else {
                    // Create new document
                    const docRef = await addDoc(plansCollection, {
                        name: planNameInput.value,
                        author: author,
                        shiftDate: shiftDate,
                        status: status, 
                        data: currentData,
                        createdAt: serverTimestamp()
                    });
                    currentDocId = docRef.id; 
                    console.log(`%c[SAVE SUCCESS] Created new shift: ${currentDocId}`, "color: green; font-weight: bold;");
                }
                
                // Success
                if(saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = isFinal ? 'Shift Finalized!' : 'Draft Saved!';
                    setTimeout(() => {
                        saveBtn.textContent = 'Save Current Plan';
                    }, 2000);
                }
                return true;
                
            } catch (error) {
                if (error.code === 'permission-denied' && retryCount < 3) {
                    console.warn("Permission denied during save, retrying...", retryCount);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return saveShiftData(isFinal, retryCount + 1);
                }
                console.error("Error saving plan:", error);
                if(saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Error Saving';
                }
                return false;
            }
        }


        // --- Leaderboard Logic (Aggregated) ---
        async function initLeaderboard() {
            if (!isAuthReady || !db) return;

            const refreshBtn = document.getElementById('refresh-leaderboard-btn');
            if(refreshBtn) {
                refreshBtn.addEventListener('click', () => loadLeaderboard());
            }
            // Initial load
            loadLeaderboard();
        }

        function calculateShiftPercentages(data) {
            const val = (key) => parseFloat(data[key]) || 0;
            
            // WEIGHTS CONFIGURATION
            const weights = {
                sales: 15,
                gc: 10,
                ac: 10,
                rw: 10,
                oepe: 15,
                r2p: 15,
                cfs: 10,
                checklist: 15 
            };

            // Helper for Weighted Calculation
            const calcWeighted = (actual, target, weight, isLowerBetter) => {
                if (target === undefined || target === null || isNaN(target) || target === "" || target == 0) return 0;
                
                let achievementRatio = 0;

                if (isLowerBetter) {
                    if (actual === 0) {
                        achievementRatio = 1; 
                    } else if (actual <= target) {
                        achievementRatio = 1; 
                    } else {
                        achievementRatio = target / actual;
                    }
                } else {
                    if (actual >= target) {
                        achievementRatio = 1; 
                    } else {
                        achievementRatio = actual / target;
                    }
                }
                achievementRatio = Math.min(Math.max(achievementRatio, 0), 1);
                return parseFloat((achievementRatio * weight).toFixed(2));
            };

            const sales = calcWeighted(val('actual-sales'), val('target-sales'), weights.sales, false);
            const gc = calcWeighted(val('actual-gc'), val('target-gc'), weights.gc, false);
            const ac = calcWeighted(val('actual-ac'), val('target-ac'), weights.ac, false);
            const cfs = calcWeighted(val('actual-cfs'), val('target-cfs'), weights.cfs, false);
            
            const rw = calcWeighted(val('actual-rw'), val('target-rw'), weights.rw, true);
            const oepe = calcWeighted(val('actual-oepe'), val('target-oepe'), weights.oepe, true);
            const r2p = calcWeighted(val('actual-r2p'), val('target-r2p'), weights.r2p, true);

            // Checklists Calculation - Pro-rated against weight
            let checked = 0;
            let totalCheckboxes = 0;
            Object.keys(data).forEach(k => {
                if (k.startsWith('check-')) {
                    totalCheckboxes++;
                    if (data[k]) checked++;
                }
            });
            
            const checklistRatio = totalCheckboxes === 0 ? 0 : (checked / totalCheckboxes);
            const checklist = parseFloat((checklistRatio * weights.checklist).toFixed(2));

            // Total Consolidated Score
            const overall = parseFloat((sales + gc + ac + cfs + rw + oepe + r2p + checklist).toFixed(2));

            return { sales, gc, ac, cfs, rw, oepe, r2p, checklist, overall };
        }

        async function loadLeaderboard(retryCount = 0) {
             const tbody = document.getElementById('leaderboard-body');
             const headerTitle = document.querySelector('#tab-leaderboard h2'); 
             if(!tbody) return;
             
             if (!auth.currentUser) {
                 return;
             }

             // MONTHLY FILTER LOGIC
             const now = new Date();
             const currentYear = now.getFullYear();
             const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
             const currentMonthKey = `${currentYear}-${currentMonth}`;
             
             const monthName = now.toLocaleString('default', { month: 'long', year: 'numeric' });

             if (headerTitle) {
                 headerTitle.innerHTML = `Manager Leaderboard <span class="text-gray-500 text-lg font-normal">- ${monthName}</span>`;
                 headerTitle.nextElementSibling.textContent = "Ranking based on accumulated achievement for the current month";
             }
             
             if (retryCount === 0) {
                 const thead = document.querySelector('#tab-leaderboard thead tr');
                 if(thead) {
                     thead.innerHTML = `
                        <th class="py-3 px-4 font-semibold w-16 text-center">Rank</th>
                        <th class="py-3 px-4 font-semibold">Manager</th>
                        <th class="py-3 px-4 font-semibold text-center bg-yellow-50 text-mcd-red border-x border-yellow-100">Total Pts</th>
                        <th class="py-3 px-2 font-semibold text-center text-xs text-gray-500">Sales (15)</th>
                        <th class="py-3 px-2 font-semibold text-center text-xs text-gray-500">GC (10)</th>
                        <th class="py-3 px-2 font-semibold text-center text-xs text-gray-500">RW (10)</th>
                        <th class="py-3 px-2 font-semibold text-center text-xs text-gray-500">CFS (10)</th>
                        <th class="py-3 px-2 font-semibold text-center text-xs text-gray-500">OEPE (15)</th>
                        <th class="py-3 px-2 font-semibold text-center text-xs text-gray-500">AC (10)</th>
                        <th class="py-3 px-2 font-semibold text-center text-xs text-gray-500">R2P (15)</th>
                        <th class="py-3 px-2 font-semibold text-center text-xs text-gray-500">Checklist (15)</th>
                     `;
                 }
                 tbody.innerHTML = '<tr><td colspan="11" class="px-6 py-10 text-center text-gray-500">Loading rankings for ' + monthName + '...</td></tr>';
             }
             
             try {
                // DIRECT PATH
                const plansCollection = collection(db, 'shift_plans');
                
                const q = query(plansCollection, limit(200)); 
                
                const snapshot = await getDocs(q);
                
                let aggregatedStats = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const manager = data.author || 'Unknown';
                    
                    if(data.status !== 'completed') return;
                    if(manager === 'Unknown' || !manager) return;

                    // Ensure the shift date starts with "YYYY-MM"
                    if (!data.shiftDate || !data.shiftDate.startsWith(currentMonthKey)) {
                        return; // Skip shifts not in this month
                    }

                    const pts = calculateShiftPercentages(data.data || {});
                    
                    if (!aggregatedStats[manager]) {
                        aggregatedStats[manager] = {
                            count: 0,
                            sumOverall: 0,
                            sumSales: 0, sumGC: 0, sumRW: 0, sumCFS: 0,
                            sumOEPE: 0, sumAC: 0, sumR2P: 0, sumChecklist: 0
                        };
                    }
                    
                    const s = aggregatedStats[manager];
                    s.count++;
                    s.sumOverall += pts.overall;
                    s.sumSales += pts.sales;
                    s.sumGC += pts.gc;
                    s.sumRW += pts.rw;
                    s.sumCFS += pts.cfs;
                    s.sumOEPE += pts.oepe;
                    s.sumAC += pts.ac;
                    s.sumR2P += pts.r2p;
                    s.sumChecklist += pts.checklist;
                });

                // Calculate Averages
                let leaderboardArray = Object.keys(aggregatedStats).map(manager => {
                    const s = aggregatedStats[manager];
                    const avg = (key) => parseFloat((s[key] / s.count).toFixed(2));
                    
                    return {
                        manager: manager,
                        shifts: s.count,
                        overall: avg('sumOverall'),
                        sales: avg('sumSales'),
                        gc: avg('sumGC'),
                        rw: avg('sumRW'),
                        cfs: avg('sumCFS'),
                        oepe: avg('sumOEPE'),
                        ac: avg('sumAC'),
                        r2p: avg('sumR2P'),
                        checklist: avg('sumChecklist')
                    };
                });

                leaderboardArray.sort((a, b) => b.overall - a.overall);
                
                if(leaderboardArray.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="11" class="px-6 py-10 text-center text-gray-500">No completed shifts recorded yet for ${monthName}.</td></tr>`;
                    return;
                }

                // Render
                tbody.innerHTML = leaderboardArray.map((entry, index) => {
                    const rank = index + 1;
                    let rankClass = 'rank-other';
                    if(rank === 1) rankClass = 'rank-1';
                    if(rank === 2) rankClass = 'rank-2';
                    if(rank === 3) rankClass = 'rank-3';
                    
                    const cell = (val, max) => {
                        const isMax = Math.abs(val - max) < 0.1; 
                        if (isMax) return `<span class="text-green-600 font-extrabold text-xs">${val}</span>`;
                        return `<span class="text-gray-600 font-medium text-xs">${val}</span>`;
                    };

                    return `
                        <tr class="hover:bg-gray-50 border-b border-gray-100 transition-colors">
                            <td class="py-3 px-4 whitespace-nowrap text-center">
                                <div class="leaderboard-rank ${rankClass} mx-auto">${rank}</div>
                            </td>
                            <td class="py-3 px-4 whitespace-nowrap">
                                <div class="text-sm font-bold text-gray-900">${entry.manager}</div>
                                <div class="text-xs text-gray-400">${entry.shifts} Shift(s)</div>
                            </td>
                            <td class="py-3 px-4 whitespace-nowrap text-center bg-yellow-50 border-x border-yellow-100">
                                <span class="text-lg font-extrabold text-mcd-red">${entry.overall}%</span>
                            </td>
                            <td class="py-3 px-2 text-center">${cell(entry.sales, 15)}</td>
                            <td class="py-3 px-2 text-center">${cell(entry.gc, 10)}</td>
                            <td class="py-3 px-2 text-center">${cell(entry.rw, 10)}</td>
                            <td class="py-3 px-2 text-center">${cell(entry.cfs, 10)}</td>
                            <td class="py-3 px-2 text-center">${cell(entry.oepe, 15)}</td>
                            <td class="py-3 px-2 text-center">${cell(entry.ac, 10)}</td>
                            <td class="py-3 px-2 text-center">${cell(entry.r2p, 15)}</td>
                            <td class="py-3 px-2 text-center">${cell(entry.checklist, 15)}</td>
                        </tr>
                    `;
                }).join('');
             } catch(e) {
                 if (e.code === 'permission-denied' && retryCount < 3) {
                     console.warn("Permission denied loading leaderboard, retrying...", retryCount);
                     setTimeout(() => loadLeaderboard(retryCount + 1), 1500); 
                     return;
                 }
                 console.error("Error loading leaderboard:", e);
                 tbody.innerHTML = '<tr><td colspan="11" class="px-6 py-10 text-center text-red-500">Error loading data.</td></tr>';
             }
        }
        
        // Helper to calculate score from raw saved data object
        function calculateScoreFromData(data) {
            let score = 0;
            let salesHit = false;
            let oepeHit = false;
            
            // Helper to parse float from data safely
            const val = (key) => parseFloat(data[key]) || 0;

            // 1. Hit Sales Target (+15 pts)
            const targetSales = val('target-sales');
            const actualSales = val('actual-sales');
            if (targetSales > 0 && actualSales >= targetSales) {
                score += 15;
                salesHit = true;
            }

            // 2. OEPE Speed (+15 pts)
            const actualOEPE = val('actual-oepe');
            const targetOEPE = val('target-oepe');
            if (targetOEPE > 0 && actualOEPE <= targetOEPE) {
                score += 15;
                oepeHit = true;
            }
            
            // 3. Other Metrics
            if(val('target-gc') > 0 && val('actual-gc') >= val('target-gc')) score += 10;
            if(val('target-ac') > 0 && val('actual-ac') >= val('target-ac')) score += 10;
            
            const rwTarget = val('target-rw');
            const rwActual = val('actual-rw');
            if(rwActual <= rwTarget) score += 10;

            if(val('target-r2p') > 0 && val('actual-r2p') <= val('target-r2p')) score += 10;
            if(val('target-cfs') > 0 && val('actual-cfs') >= val('target-cfs')) score += 10;

            // 4. Checklists (+20 pts pro-rated)
            let checkedCount = 0;
            Object.keys(data).forEach(key => {
                if(key.startsWith('check-') && data[key] === true) {
                    checkedCount++;
                }
            });
            const EST_TOTAL_TASKS = 60;
            const checklistScore = Math.min(20, Math.round((checkedCount / EST_TOTAL_TASKS) * 20));
            score += checklistScore;
            
            return { score, salesHit, oepeHit };
        }


        // RESTORED FULL TASK LISTS
        const preShiftTasks = [
            {
                title: "Shift Preparation (Completed the day before)",
                tasks: [
                    "Review sales projections, compute and set targets and anticipate events for the day, current promotions and tie-ups",
                    "Plan and check for shift schedule and positioning according to the positioning guide",
                    "Read Manager's communication log, project briefs, and store performance from the previous day",
                    "Review Daily Food Safety checklist/ DFS for previous Manager/ day part including channels. Ensure all crew are aware of all safety procedures.",
                    "Check and prepare for ordering of buns as per ordering day.",
                    "Check PM/BM Schedule, Training schedule and PR/WR"
                ]
            },
            {
                title: "Outside the Restaurant (Completed on approach)",
                tasks: [
                    "Parking lot & neighborhood free from litter (3 min walk)",
                    "Drive-thru speaker post/ Customer Order display (COD), IP camera (SBS type) and HHOT are clean and in good",
                    "Drive Thru lane/menu boards and landscaping clean and litter free.",
                    "Drive Thru menu boards correct, updated prices, clean, readable, and as per merchandising guide",
                    "Drive Thru windows are clean and locked when not in use.",
                    "POPs in place ie streamer, banner as per merchandising guide, and in good condition",
                    "Signages and pin lights are clean and in good condition-Wash hands upon entering the restaurant."
                ]
            },
            {
                title: "Customer Areas",
                tasks: [
                    "Windows/glass/ doors are clean and free from hand marks.",
                    "Interior/Exterior dining area tables and chairs are arranged properly. Floors are clean and dry. Appropriate lighting. HVAC clean, working and with check temp at 76F.Music management is playing at the background and updated.",
                    "Check WIFI/ connectivity status of all terminals and devices.",
                    "Party area with d√©cor, projector, and screen clean and working, odor free and organized.",
                    "Interior/Exterior dining area trash bins are changed or mashed down and odor free. Waste Segregation are followed.",
                    "Customer trays are clean and sanitized. High chairs, trays, cutleries and gravy are available and clean.",
                    "Ceiling, vents, lighting, walls, and in-store signages clean, visible and readable for all guest",
                    "Playplace floors, seating and equipment clean and safe.",
                    "Utility bags, mop buckets, color-coded mops, spot sweeper, spray bottle, wet floor sign clean and available",
                    "Restroom floors, toilet bowl, urinals, sink and mirror clean, soap, tissue are stocked, odor-free, hand-dryer functioning",
                    "Customers handwash area floors, sink and mirrors clean, soap stocked and hand dryer functioning",
                    "Self Ordering Kiosk working and smudge-free, check merchandising, product outage, cashless terminals (Check ECR), WIFI, and table tent and holder clean, sanitized and in good condition. Use proper cleaning materials.",
                    "Happy Meal merchandiser and Order Ready Boards are clean and in good condition."
                ]
            },
            {
                title: "Service Area",
                tasks: [
                    "Front Counter/Take out counter menu board/DMB layout and price correct (including CRTs) based on merchandising",
                    "Check finished product quality, taste test products, and holding times adhered to",
                    "POS, printers, cashless terminals (Check ECR), money detector functioning properly with enough thermal paper stocks and change in drawers. RMHC canisters in place and sanitize every 10-15 mins during peak period.",
                    "Sanitised towels, clean and soiled towel buckets available, clean and timed (Check sanitiser solution, 100ppm)",
                    "Centre Island, front area and undercounters clean, DPS presenter side, HLZ/OAT area clean organized w/ sanitizer bottle",
                    "Center island, condiment cart (DT, and DPS area) in mirror image and stocked",
                    "Front Counter/Drive Thru/Take-out counter floors clean and dry",
                    "Beverage Cell area stocked, KVS, bump bars and BLZ, clean and good condition. Verify service times of KVS drinks",
                    "Equipment (Sundae Machine, beverage system with diffusers/nozzles, coffee machine, hot chocolate machine, juice dispensers, HLZ, OAT etc) calibrated, clean, sanitized & in good repair",
                    "Equipmet KVS, bumpbars, pick list printers, Mini-ORB, HHOT, and scanners (For DT, FC, and OK) are clean, sanitized frequently and in good repair. Check service times."
                ]
            },
            {
                title: "Production Area",
                tasks: [
                    "Fry station equipment available, clean and in good working condition. Check product quality and stocks",
                    "Equipment (Grills, Fryers, Rapid Toasters/HEBT, HLZ/OAT, Vertical and Overhead Transporter, UHC, holding cabinet, marinators, steamer, Spaghetti Vat, smart carrier, rice cooker, egg cooker, hotcake griddle, muffin toaster etc) clean & in good repair",
                    "Small equipments (UHC clips and tongs etc.) complete and in use, clean and sanitized at least every 4 hours",
                    "Check MFY Line set up, Check KVS, bumpbars, grill printers and stickers, radio clean, working and stocked.",
                    "UHC clean and working. Production Baseline Chart updated and followed. Check Product quality and taste-testing",
                    "Exhaust system, working. Filters clean. Scrapers & spatula blades changed every month",
                    "Preparation of onions are consistently correct, and proper tempering of sauces and cheese. Products on the prep table is used within holding time.",
                    "Chicken thawing are followed, updated and properly accomplished.",
                    "Chicken holding time is being followed. Rice & gravy holding times are being followed and within holding time",
                    "Product area stocked for 24/2, clean and secondary timers present including tempering and proper thawing",
                    "3d compartment sink set up properly. Waste segregation followed. Reusables utensils washed, rinse and sanitised",
                    "Refrigerator/freezers, dressing table clean, organized, rotated, and stocked. Sauce Dispensers stocked, calibrated and in working condition",
                    "Mop buckets set up, floors and walls clean and sanitised. Grease trap clean every night and odor-free.",
                    "Sanitized towels and grill cloths available, clean and sanitized. Complete towel system set-up and chemical rack",
                    "Handwash area stocked, clean and in good repair ie warm water, AMH, clear gloves with sizes, hand dryer"
                ]
            },
            {
                title: "Other/Remote Areas",
                tasks: [
                    "Walk-in freezer and refrigerator temperature, clean, organized, rotated, enough stock available & locked",
                    "Dry stock areas temperature, clean, tidy, rotated, enough stock and locked",
                    "Ice Machine, Ice scooper, Ice bucket in clean, sanitised and working condition.",
                    "Safety checks for CO2 (chained and locked) and CO2 detector working",
                    "HVAC clean, functioning & comfortable",
                    "Beverage syrup area clean, sanitized and stocked (check UTD)",
                    "Back door locked Alarm working, exit signs lit and visible. Crew room clean and tidy.",
                    "Crew room clean and comfortable. E-learning area clean, working and in use during training. Bulletin Boards minimums updated, clean and organized.",
                    "Crew Room restroom clean, odor free and good working condition to be used by 1 crew at time.",
                    "Corral area, gas room, pump room, genset room, rooftop, lactation room clean, Waste water treatment facility clean, odor free and organized-Crew to wear mask. gloves and apron when cleaning the corral and during trash out",
                    "Birthday party booth and amenities room and party characters complete, clean, odor free and organized"
                ]
            }
        ];
        
        // Empty during shift tasks as requested
        const duringShiftTasks = [];
        
        const travelPathTasks = [
            {
                title: "Outside Restaurant",
                tasks: [
                    "Parking lot & neighborhood free from litter (3 min walk)",
                    "All outside storages are lock"
                ]
            },
            {
                title: "Customer Areas",
                tasks: [
                    "Windows/glass / doors are clean and free from hand marks.",
                    "Interior / Exterior dining area tables and chairs are arranged properly.",
                    "Floor is clean and dry",
                    "Temperature acceptable",
                    "Music is not too loud",
                    "Male CR floor is clean and dry and has enough chemical and tissue",
                    "Female CR floor is clean and dry and has enough chemical and tissue",
                    "Hand wash area is clean and dry and has enough AMH. SOK has thermal ready and cashless terminals are in ECR mode"
                ]
            },
            {
                title: "Front Counter",
                tasks: [
                    "My cashiers has enough bills and coins",
                    "Spare thermal paper at pos printer side available",
                    "All condiments ready",
                    "Reusable spoon and fork ready",
                    "Floor is clean and dry"
                ]
            },
            {
                title: "BevCell",
                tasks: [
                    "Mix hopper is 3/4 full",
                    "Topping dispensers 3/4 full",
                    "Cups and Lids enough",
                    "Ice bins are full",
                    "Iced coffee based enough",
                    "Hot coffee enough",
                    "Milk dispenser has enough milk and within temperature",
                    "Charts are updated",
                    "Area is clean and dry including equipments"
                ]
            },
            {
                title: "Drive-Thru Present Area",
                tasks: [
                    "All condiments ready and mirror image",
                    "OEPE is within or below target/dashboard targets are all green"
                ]
            },
            {
                title: "Fries Station",
                tasks: [
                    "Salt dispenser is 3/4 full",
                    "All bags are available and enough",
                    "Enough bags ready for serving",
                    "Fries freezer has enough fries bags inside",
                    "Vats are skimmed and closed when not in use",
                    "Dump Tray has acceptable amount of salt",
                    "Area is clean and dry"
                ]
            },
            {
                title: "FPCN/Chicken Vat",
                tasks: [
                    "All vats are closed when not in use",
                    "All vats are filtered and clean",
                    "Reach-in Freezer has enough frozen products",
                    "Dip baskets water are replaced.",
                    "Breader is sieved",
                    "Has enough chicken ready for breading"
                ]
            },
            {
                title: "Towel Buckets",
                tasks: [
                    "All buckets has sanitized water at 100ppm concentration",
                    "Has enough towels that can be used.",
                    "Area is clean"
                ]
            },
            {
                title: "Chicken Cabinet",
                tasks: [
                    "Enough chicken available based on build to's",
                    "Tongs are available",
                    "Chickens are within holding time",
                    "Clean area"
                ]
            },
            { 
                title: "UHC", 
                tasks: [
                    "All products inside UHC follow the baseline",
                    "Products quality is acceptable",
                    "All tongs are available",
                    "Trays are clean"
                ] 
            },
            { 
                title: "Grill Side Freezer", 
                tasks: [
                    "All patties build to's are followed",
                    "Temperature inside is within range"
                ] 
            },
            { 
                title: "Charts", 
                tasks: [
                    "All product tempering charts are updated and followed"
                ] 
            },
            { 
                title: "Backroom", 
                tasks: [
                    "Enough BIB's at backroom",
                    "Compartment sinks are set up",
                    "Area is clean and dry",
                    "Cleaning and Sanitation charts are updated"
                ] 
            },
            { 
                title: "Crew Room", 
                tasks: [
                    "Area is clean and dry including CR"
                ] 
            },
            { 
                title: "Dry Storage", 
                tasks: [
                    "All products are rotated (FIFO)",
                    "Clean and organized"
                ] 
            },
            { 
                title: "Chiller", 
                tasks: [
                    "Temperature of chiller and freezer are all within range",
                    "All products are rotated (FIFO)",
                    "Enough soaked onions and onion shaker is filled",
                    "Ready to use shredded lettuce and enough supply for a day",
                    "Tempered sliced cheese available",
                    "Ready to use sliced tomato",
                    "Enough thawed chicken",
                    "Enough Spag Sauce thawed",
                    "Ready mix of Soft Serve",
                    "Area is clean, dry, and organized"
                ] 
            },
            { 
                title: "Freezer", 
                tasks: [
                    "All products are rotated (FIFO)",
                    "No boxes opened",
                    "Freezer door is closed properly"
                ] 
            }
        ];
        
        const postShiftTasks = [];


        // --- Utility Functions ---
        function createSlug(text) {
            if (typeof text !== 'string') { return ''; }
            return text.toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
        }

        function createTaskItem(taskText, sectionSlug, taskIndex) {
            const taskId = `task-${sectionSlug}-task-${taskIndex}`;
            return `
                <div class="task-item py-3 flex flex-col md:flex-row md:items-center hover:bg-gray-50 transition-colors rounded-lg px-2">
                    <div class="flex items-center flex-1 mb-2 md:mb-0 group cursor-pointer">
                        <div class="relative flex items-center">
                            <!-- Added task-checkbox class back here -->
                            <input type="checkbox" id="check-${taskId}" data-task-id="${taskId}" data-section="${sectionSlug}" class="task-checkbox peer appearance-none h-6 w-6 border-2 border-gray-300 rounded checked:bg-green-500 checked:border-green-500 transition-all cursor-pointer" onclick="updateCurrentShiftScore()">
                            <svg class="absolute w-4 h-4 text-white hidden peer-checked:block pointer-events-none left-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <label for="check-${taskId}" class="ml-3 text-gray-700 font-medium peer-checked:text-gray-400 peer-checked:line-through transition-colors cursor-pointer select-none flex-1 py-2">${taskText}</label>
                    </div>
                    <div class="flex items-center w-full md:w-auto pl-9 md:pl-0">
                        <input type="text" id="notes-${taskId}" data-task-id="${taskId}" placeholder="Note..." class="task-notes border-0 border-b border-gray-200 bg-transparent focus:border-yellow-400 focus:ring-0 text-sm w-full md:w-48 mr-2 transition-colors">
                        <button class="reminder-btn text-gray-400 hover:text-yellow-500 transition-colors p-1" data-task-id="${taskId}" data-task-name="${taskText}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createAccordionSection(title, tasks) {
            const sectionSlug = createSlug(title);
            const tasksHtml = tasks.map((task, index) => createTaskItem(task, sectionSlug, index)).join('');
            
            return `
                <div class="accordion-item bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4 transition-all duration-200 hover:shadow-md">
                    <div class="accordion-header p-4 cursor-pointer select-none bg-white border-l-4 border-transparent hover:border-mcd-yellow transition-all" onclick="window.toggleAccordion(this)">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                ${title}
                                <span id="badge-${sectionSlug}" class="hidden ml-3 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full font-bold">DONE</span>
                            </h3>
                            <div class="flex items-center">
                                <span id="count-${sectionSlug}" class="text-xs text-gray-500 font-semibold mr-3">0/${tasks.length}</span>
                                <svg class="accordion-arrow h-5 w-5 text-gray-400 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                            <div id="progress-${sectionSlug}" class="bg-mcd-yellow h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="accordion-content bg-gray-50 border-t border-gray-100 hidden">
                        <div class="p-4 pt-2">
                            <div class="flex justify-end mb-2 space-x-2">
                                <button onclick="toggleSectionTasks('${sectionSlug}', true)" class="text-xs font-bold text-green-600 hover:bg-green-50 px-3 py-1 rounded transition-colors border border-transparent hover:border-green-200">Check All</button>
                                <button onclick="toggleSectionTasks('${sectionSlug}', false)" class="text-xs font-bold text-gray-500 hover:bg-gray-100 px-3 py-1 rounded transition-colors">Reset</button>
                            </div>
                            <div class="space-y-1">
                                ${tasksHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function setupAccordions() {
            const preShiftContainer = document.getElementById('pre-shift-accordion-container');
            const duringShiftContainer = document.getElementById('during-shift-accordion-container');
            const travelPathContainer = document.getElementById('travel-path-accordion-container');
            const postShiftContainer = document.getElementById('post-shift-accordion-container');
            
            if(preShiftContainer) preShiftContainer.innerHTML = preShiftTasks.map(section => createAccordionSection(section.title, section.tasks)).join('');
            if(duringShiftContainer) duringShiftContainer.innerHTML = duringShiftTasks.map(section => createAccordionSection(section.title, section.tasks)).join('');
            if(travelPathContainer) travelPathContainer.innerHTML = travelPathTasks.map(section => createAccordionSection(section.title, section.tasks)).join('');
            if(postShiftContainer) postShiftContainer.innerHTML = postShiftTasks.map(section => createAccordionSection(section.title, section.tasks)).join('');

            document.querySelectorAll('.collapse-section-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const accordionItem = e.target.closest('.accordion-item');
                    if (accordionItem) {
                        const content = accordionItem.querySelector('.accordion-content');
                        const arrow = accordionItem.querySelector('.accordion-arrow');
                        if(content) content.classList.remove('open', 'hidden');
                        if(content) content.classList.add('hidden');
                        if(arrow) arrow.classList.remove('open');
                    }
                });
            });
        }
        
        window.toggleAccordion = function(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.accordion-arrow');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                setTimeout(() => content.classList.add('open'), 10);
                arrow.classList.add('open');
            } else {
                content.classList.remove('open');
                arrow.classList.remove('open');
                setTimeout(() => content.classList.add('hidden'), 300);
            }
        };

        window.toggleSectionTasks = function(sectionSlug, checkState) {
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-section="${sectionSlug}"]`);
            checkboxes.forEach(cb => {
                cb.checked = checkState;
            });
            updateCurrentShiftScore();
        };
        
        function setupReminders() {
            const modalBg = document.getElementById('reminder-modal-bg');
            const modal = document.getElementById('reminder-modal');
            const taskNameEl = document.getElementById('reminder-task-name');
            const reminderTimeInput = document.getElementById('reminder-time');
            const setReminderBtn = document.getElementById('set-reminder-btn');
            const cancelReminderBtn = document.getElementById('cancel-reminder-btn');
            const acknowledgeAlertBtn = document.getElementById('acknowledge-alert-btn');
            const alertBox = document.getElementById('alert-box');
            const alertMessage = document.getElementById('alert-message');
            const travelPathAlarm = document.getElementById('travel-path-alarm-toggle');

            let taskToRemind = '';
            let travelPathTimerId = null;

            document.body.addEventListener('click', (e) => {
                const btn = e.target.closest('.reminder-btn');
                if (btn) {
                    taskToRemind = btn.dataset.taskName;
                    taskNameEl.textContent = `Task: ${taskToRemind}`;
                    modalBg.classList.remove('hidden');
                    modalBg.classList.add('flex');
                    setTimeout(() => {
                        modalBg.classList.remove('opacity-0');
                        modal.classList.remove('scale-95', 'opacity-0');
                    }, 10);
                }
            });

            const closeModal = () => {
                modalBg.classList.add('opacity-0');
                modal.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modalBg.classList.add('hidden');
                    modalBg.classList.remove('flex');
                }, 300);
            };

            if (cancelReminderBtn) cancelReminderBtn.addEventListener('click', closeModal);
            if (modalBg) modalBg.addEventListener('click', (e) => { if (e.target === modalBg) closeModal(); });

            function stopTravelPathTimer() {
                if (travelPathTimerId) {
                    clearTimeout(travelPathTimerId);
                    travelPathTimerId = null;
                }
            }

            function startTravelPathTimer() {
                stopTravelPathTimer();
                function runAlarm() {
                    const isChecked = document.getElementById('travel-path-alarm-toggle')?.checked;
                    if (isChecked) {
                        new Notification("McDonald's Shift Manager", {
                            body: "Time to do your 30-minute travel path!",
                            icon: "https://placehold.co/192x192/c00000/ffc72c?text=M"
                        });
                        travelPathTimerId = setTimeout(runAlarm, 30 * 60 * 1000);
                    } else {
                        stopTravelPathTimer();
                    }
                }
                travelPathTimerId = setTimeout(runAlarm, 30 * 60 * 1000);
            }

            if (setReminderBtn) {
                setReminderBtn.addEventListener('click', () => {
                    const minutes = parseInt(reminderTimeInput.value, 10);
                    if (isNaN(minutes) || minutes <= 0) {
                        reminderTimeInput.focus();
                        reminderTimeInput.classList.add('border-red-500');
                        return;
                    }
                    reminderTimeInput.classList.remove('border-red-500');
                    setTimeout(() => { showAlert(taskToRemind); }, minutes * 60 * 1000);
                    closeModal();
                });
            }

            const showAlert = (message) => {
                if (alertMessage) alertMessage.textContent = message;
                if (alertBox) alertBox.classList.remove('transform', 'translate-x-full', 'opacity-0');
            };

            if (acknowledgeAlertBtn) {
                acknowledgeAlertBtn.addEventListener('click', () => {
                    if (alertBox) alertBox.classList.add('transform', 'translate-x-full', 'opacity-0');
                });
            }
            
            function checkNotificationPermission() {
                const label = document.querySelector('label[for="travel-path-alarm-toggle"]');
                if (!travelPathAlarm) return;

                if (!("Notification" in window)) {
                    travelPathAlarm.disabled = true;
                    if (label) label.classList.add('text-gray-400');
                    return;
                }

                if (Notification.permission === "denied") {
                    travelPathAlarm.disabled = true;
                    travelPathAlarm.checked = false;
                    if (label) label.classList.add('text-gray-400');
                } else {
                    travelPathAlarm.disabled = false;
                    if (label) label.classList.remove('text-gray-400');
                }
            }
            checkNotificationPermission();

            if (travelPathAlarm) {
                travelPathAlarm.addEventListener('change', () => {
                    if (travelPathAlarm.disabled) return;
                    if (travelPathAlarm.checked) {
                        if (Notification.permission === "granted") {
                            startTravelPathTimer();
                        } else { 
                            Notification.requestPermission().then(permission => {
                                if (permission === "granted") {
                                    startTravelPathTimer();
                                } else {
                                    travelPathAlarm.checked = false;
                                    checkNotificationPermission(); 
                                }
                            });
                        }
                    } else {
                        stopTravelPathTimer();
                    }
                });
            }
        }

        function setupTargetCalculations() {
            setupAutoTargets();

            document.querySelectorAll('.target-row').forEach(row => {
                const targetInput = row.querySelector('.target-input');
                const actualInput = row.querySelector('.actual-input');
                const diffOutput = row.querySelector('.diff-output');

                const calculateDiff = () => {
                    const target = parseFloat(targetInput.value) || 0;
                    const actual = parseFloat(actualInput.value) || 0;
                    const diff = actual - target;
                    
                    if (diffOutput) {
                        diffOutput.textContent = diff.toFixed(0);
                        if (diff < 0) {
                            diffOutput.classList.remove('text-green-600');
                            diffOutput.classList.add('text-red-600');
                        } else if (diff > 0) {
                            diffOutput.classList.remove('text-red-600');
                            diffOutput.classList.add('text-green-600');
                        } else {
                            diffOutput.classList.remove('text-red-600', 'text-green-600');
                        }
                    }
                    updateCurrentShiftScore(); 
                };
                
                if (targetInput) targetInput.addEventListener('input', calculateDiff);
                if (actualInput) actualInput.addEventListener('input', calculateDiff);
            });
            
            // Leader Name Input Listener
            const shiftLeaderInput = document.getElementById('shift-leader');
            if(shiftLeaderInput) {
                shiftLeaderInput.addEventListener('input', () => {
                    const name = shiftLeaderInput.value || "Your";
                    const title = document.getElementById('current-score-title');
                    if(title) title.textContent = `${name}'s Current Shift Score`;
                });
            }
        }
        
        function setupAutoTargets() {
            const salesInput = document.getElementById('target-sales');
            const rwInput = document.getElementById('target-rw');

            if (salesInput && rwInput) {
                salesInput.addEventListener('input', () => {
                    const sales = parseFloat(salesInput.value);
                    if (!isNaN(sales)) {
                        const rwTarget = (sales * 0.0015).toFixed(2);
                        rwInput.value = rwTarget;
                        rwInput.dispatchEvent(new Event('input'));
                    }
                });
            }
        }

        // --- Score Calculation Logic & Progress Bar Updates ---
        function updateCurrentShiftScore() {
            let score = 0;
            const maxScore = 100;

            const getVal = (id) => parseFloat(document.getElementById(id)?.value) || 0;
            
            // Metrics logic...
            const targetSales = getVal('target-sales');
            const actualSales = getVal('actual-sales');
            if (targetSales > 0 && actualSales >= targetSales) score += 15;

            const gcTarget = getVal('target-gc');
            const gcActual = getVal('actual-gc');
            if (gcTarget > 0 && gcActual >= gcTarget) score += 10;

            const acTarget = getVal('target-ac');
            const acActual = getVal('actual-ac');
            if (acTarget > 0 && acActual >= acTarget) score += 10;

            const rwTarget = getVal('target-rw');
            const rwActual = getVal('actual-rw');
            if(rwActual <= rwTarget) score += 10;

            const oepeTarget = getVal('target-oepe');
            const oepeActual = getVal('actual-oepe');
            if (oepeTarget > 0 && oepeActual <= oepeTarget) score += 15;

            const r2pTarget = getVal('target-r2p');
            const r2pActual = getVal('actual-r2p');
            if (r2pTarget > 0 && r2pActual <= r2pTarget) score += 10;

            const cfsTarget = getVal('target-cfs');
            const cfsActual = getVal('actual-cfs');
            if (cfsTarget > 0 && cfsActual >= cfsTarget) score += 10;

            // Global Checklist Score
            const allCheckboxes = document.querySelectorAll('.task-checkbox');
            const totalTasks = allCheckboxes.length;
            let checkedTasks = 0;
            allCheckboxes.forEach(box => {
                if (box.checked) checkedTasks++;
            });

            if (totalTasks > 0) {
                const checklistScore = Math.round((checkedTasks / totalTasks) * 20);
                score += checklistScore;
            }

            // Update Display
            const scoreDisplay = document.getElementById('current-shift-score');
            if (scoreDisplay) {
                scoreDisplay.textContent = score;
                if (score >= 90) scoreDisplay.className = "text-5xl font-extrabold mcd-green";
                else if (score >= 70) scoreDisplay.className = "text-5xl font-extrabold mcd-yellow";
                else scoreDisplay.className = "text-5xl font-extrabold mcd-text-red";
            }

            // 2. Section Progress Bar Updates
            const uniqueSections = new Set();
            document.querySelectorAll('.task-checkbox').forEach(cb => {
                if(cb.dataset.section) uniqueSections.add(cb.dataset.section);
            });

            uniqueSections.forEach(slug => {
                const sectionCheckboxes = document.querySelectorAll(`.task-checkbox[data-section="${slug}"]`);
                const total = sectionCheckboxes.length;
                let checked = 0;
                sectionCheckboxes.forEach(cb => { if(cb.checked) checked++; });
                
                const percentage = total === 0 ? 0 : (checked / total) * 100;
                
                // Update Elements
                const progressBar = document.getElementById(`progress-${slug}`);
                const countSpan = document.getElementById(`count-${slug}`);
                const badge = document.getElementById(`badge-${slug}`);
                
                if(progressBar) {
                    progressBar.style.width = `${percentage}%`;
                    if(percentage === 100) {
                        progressBar.classList.remove('bg-mcd-yellow');
                        progressBar.classList.add('bg-green-500');
                    } else {
                        progressBar.classList.add('bg-mcd-yellow');
                        progressBar.classList.remove('bg-green-500');
                    }
                }
                
                if(countSpan) {
                    countSpan.textContent = `${checked}/${total}`;
                    countSpan.className = percentage === 100 ? "text-xs text-green-600 font-bold mr-3" : "text-xs text-gray-500 font-semibold mr-3";
                }
                
                if(badge) {
                    if(percentage === 100) badge.classList.remove('hidden');
                    else badge.classList.add('hidden');
                }
            });
        }
        
        // --- Tab Navigation ---
        function showTab(tabId) {
            try {
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active-tab');
                });

                let tabToShow = document.getElementById(`tab-${tabId}`);
                let btnToActivate = document.querySelector(`[data-tab="${tabId}"]`);
                let idToSave = tabId;

                if (!tabToShow || !btnToActivate) {
                    // Default to Shift Plans if not found
                    tabToShow = document.getElementById(`tab-shift-plans`);
                    btnToActivate = document.querySelector(`[data-tab="shift-plans"]`);
                    idToSave = 'shift-plans';
                }

                if (tabToShow && btnToActivate) {
                    tabToShow.classList.remove('hidden');
                    btnToActivate.classList.add('active-tab');
                    localStorage.setItem('activeTab', idToSave);
                }
            } catch (e) {
                console.error("Error in showTab:", e);
            }
        }
        
        // --- ROBUST TO-DO LISTS ---
        
        function generateTravelPathReport() {
            const container = document.getElementById('travel-path-report-container');
            if (!container) return;
            
            let reportHtml = '';
            let itemsFound = 0;
            
            // 1. Find all accordion items within the Pre-Shift tab
            const preShiftAccordions = document.querySelectorAll('#pre-shift-accordion-container .accordion-item');
            
            preShiftAccordions.forEach(accordion => {
                const sectionTitle = accordion.querySelector('h3')?.innerText || 'Unnamed Section';
                const cleanTitle = sectionTitle.replace("DONE", "").trim();
                
                let sectionTasksHtml = '';
                
                const tasks = accordion.querySelectorAll('.task-item');
                tasks.forEach(task => {
                    const checkbox = task.querySelector('.task-checkbox');
                    const label = task.querySelector('label');
                    const notes = task.querySelector('.task-notes');
                    
                    if (checkbox && label && !checkbox.checked) {
                        itemsFound++;
                        const taskText = label.textContent || 'Unnamed Task';
                        const noteText = (notes && notes.value.trim()) ? notes.value.trim() : '';
                        
                        sectionTasksHtml += `
                            <li class="flex items-start py-2">
                                <span class="text-2xl mr-3 text-mcd-red">‚òê</span>
                                <div>
                                    <span class="text-gray-800 font-medium">${taskText}</span>
                                    ${noteText ? `<p class="text-sm mcd-text-red font-medium pl-1 mt-1 bg-red-50 p-1 rounded"><strong>Note:</strong> ${noteText}</p>` : ''}
                                </div>
                            </li>
                        `;
                    }
                });
                
                if (sectionTasksHtml) {
                    reportHtml += `
                        <div class="mb-6 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h4 class="text-lg font-bold text-mcd-red border-b border-gray-100 pb-2 mb-3">${cleanTitle}</h4>
                            <ul class="list-none space-y-1">${sectionTasksHtml}</ul>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = itemsFound === 0 ? '<div class="p-6 bg-green-50 border border-green-200 rounded-lg text-center"><p class="text-green-700 font-bold text-lg">‚úÖ All pre-shift tasks are complete!</p><p class="text-green-600 text-sm">Great job setting up the shift.</p></div>' : reportHtml;
        }

        function generateTravelPathToDoReport() {
            const container = document.getElementById('travel-path-todo-list-container');
            if (!container) return;
            
            let reportHtml = '';
            let itemsFound = 0;
            
            // 1. Find all accordion items within the Travel Path tab's "Full Checklist"
            const travelPathAccordions = document.querySelectorAll('#travel-path-accordion-container .accordion-item');
            
            travelPathAccordions.forEach(accordion => {
                const sectionTitle = accordion.querySelector('h3')?.innerText || 'Unnamed Section';
                const cleanTitle = sectionTitle.replace("DONE", "").trim();
                let sectionTasksHtml = '';
                
                const tasks = accordion.querySelectorAll('.task-item');
                tasks.forEach(task => {
                    const checkbox = task.querySelector('.task-checkbox');
                    const label = task.querySelector('label');
                    const notes = task.querySelector('.task-notes');
                    
                    if (checkbox && label && !checkbox.checked) {
                        itemsFound++;
                        const taskText = label.textContent || 'Unnamed Task';
                        const noteText = (notes && notes.value.trim()) ? notes.value.trim() : '';
                        
                        sectionTasksHtml += `
                            <li class="flex items-start py-2">
                                <span class="text-2xl mr-3 text-mcd-red">‚òê</span>
                                <div>
                                    <span class="text-gray-800 font-medium">${taskText}</span>
                                    ${noteText ? `<p class="text-sm mcd-text-red font-medium pl-1 mt-1 bg-red-50 p-1 rounded"><strong>Note:</strong> ${noteText}</p>` : ''}
                                </div>
                            </li>
                        `;
                    }
                });
                
                if (sectionTasksHtml) {
                    reportHtml += `
                        <div class="mb-6 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h4 class="text-lg font-bold text-mcd-red border-b border-gray-100 pb-2 mb-3">${cleanTitle}</h4>
                            <ul class="list-none space-y-1">${sectionTasksHtml}</ul>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = itemsFound === 0 ? '<div class="p-6 bg-green-50 border border-green-200 rounded-lg text-center"><p class="text-green-700 font-bold text-lg">‚úÖ Travel Path is clear!</p><p class="text-green-600 text-sm">Excellent standards maintained.</p></div>' : reportHtml;
        }


        function setupAccordionControls() {
            document.querySelectorAll('.tab-content').forEach(tabContent => {
                const expandBtn = tabContent.querySelector('.expand-all-btn');
                const collapseBtn = tabContent.querySelector('.collapse-all-btn');
                const accordionContainer = tabContent.querySelector('[id$="-accordion-container"]');
                if (!accordionContainer) return;

                if (expandBtn) {
                    expandBtn.addEventListener('click', () => {
                        const items = accordionContainer.querySelectorAll('.accordion-item');
                        items.forEach(item => {
                            const content = item.querySelector('.accordion-content');
                            const arrow = item.querySelector('.accordion-arrow');
                            content.classList.remove('hidden');
                            setTimeout(() => content.classList.add('open'), 10);
                            arrow.classList.add('open');
                        });
                    });
                }
                if (collapseBtn) {
                    collapseBtn.addEventListener('click', () => {
                        const items = accordionContainer.querySelectorAll('.accordion-item');
                        items.forEach(item => {
                            const content = item.querySelector('.accordion-content');
                            const arrow = item.querySelector('.accordion-arrow');
                            content.classList.remove('open');
                            arrow.classList.remove('open');
                            setTimeout(() => content.classList.add('hidden'), 300);
                        });
                    });
                }
            });
        }

        function setupTravelPathSubTabs() {
            const tabContainer = document.getElementById('tab-travel-path');
            if (!tabContainer) return;

            const subTabButtons = tabContainer.querySelectorAll('.sub-tab-btn');
            const subTabContents = tabContainer.querySelectorAll('.sub-tab-content');

            subTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const subTabId = button.dataset.subTab;
                    subTabButtons.forEach(btn => btn.classList.remove('active-sub-tab'));
                    subTabContents.forEach(content => content.classList.add('hidden'));
                    button.classList.add('active-sub-tab');
                    const contentToShow = tabContainer.querySelector(`#sub-tab-${subTabId}`);
                    if (contentToShow) contentToShow.classList.remove('hidden');
                });
            });

            const defaultSubTab = tabContainer.querySelector('.sub-tab-btn[data-sub-tab="checklist"]');
            const defaultSubTabContent = tabContainer.querySelector('#sub-tab-checklist');
            if(defaultSubTab) defaultSubTab.classList.add('active-sub-tab');
            if(defaultSubTabContent) defaultSubTabContent.classList.remove('hidden');
        }

        // --- FIRESTORE SHIFT MANAGEMENT FUNCTIONS ---

        function clearShiftForm() {
            document.querySelectorAll('#tab-shift-plans .dashboard-input, #tab-shift-targets .dashboard-input').forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            
            document.querySelectorAll('.task-checkbox').forEach(box => {
                box.checked = false;
            });
            
            document.querySelectorAll('.task-notes').forEach(note => {
                note.value = '';
            });

            document.querySelectorAll('.diff-output').forEach(diff => {
                diff.textContent = '0';
                diff.classList.remove('text-red-600', 'text-green-600');
            });
            
            updateCurrentShiftScore();
            currentDocId = null;
        }

        function scrapeDataFromForm() {
            const shiftData = {};

            document.querySelectorAll('[data-save]').forEach(input => {
                const key = input.dataset.save;
                if (input.type === 'checkbox') {
                    shiftData[key] = input.checked;
                } else {
                    shiftData[key] = input.value;
                }
            });
            
            document.querySelectorAll('.task-checkbox').forEach(box => {
                const key = `check-${box.dataset.taskId}`;
                shiftData[key] = box.checked;
            });
            
            document.querySelectorAll('.task-notes').forEach(note => {
                const key = `notes-${note.dataset.taskId}`;
                if (key && note.value) { 
                    shiftData[key] = note.value;
                }
            });
            
            return shiftData;
        }

        function populateFormWithData(data) {
            if (!data) return;
            
            clearShiftForm();

            document.querySelectorAll('[data-save]').forEach(input => {
                const key = input.dataset.save;
                if (data[key] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = data[key];
                    } else {
                        input.value = data[key];
                    }
                    if (input.classList.contains('target-input') || input.classList.contains('actual-input')) {
                        input.dispatchEvent(new Event('input'));
                    }
                    if (input.id === 'travel-path-alarm-toggle') {
                         input.dispatchEvent(new Event('change'));
                    }
                }
            });
            
            document.querySelectorAll('.task-checkbox').forEach(box => {
                const key = `check-${box.dataset.taskId}`;
                box.checked = data[key] === true;
            });
            
            document.querySelectorAll('.task-notes').forEach(note => {
                const key = `notes-${note.dataset.taskId}`;
                if (key && data[key] !== undefined) {
                    note.value = data[key];
                }
            });
            
            updateCurrentShiftScore();
        }

        // --- AI SUMMARY FUNCTIONS ---
        const generateSummaryBtn = document.getElementById('generate-summary-btn');
        const loadingModalBg = document.getElementById('ai-loading-modal-bg');
        const loadingModal = document.getElementById('ai-loading-modal');
        const resultModalBg = document.getElementById('ai-result-modal-bg');
        const resultModal = document.getElementById('ai-result-modal');
        const aiSummaryOutput = document.getElementById('ai-summary-output');
        const closeResultBtn = document.getElementById('close-ai-result-btn');
        const closeResultBtn2 = document.getElementById('close-ai-result-btn-2');
        const copySummaryBtn = document.getElementById('copy-summary-btn');
        
        // Finalization Modal Elements
        const finalizeModalBg = document.getElementById('finalize-modal-bg');
        const finalizeModal = document.getElementById('finalize-modal');
        const finalizeName = document.getElementById('finalize-name');
        const finalizeDate = document.getElementById('finalize-date');
        const closeFinalizeBtn = document.getElementById('close-finalize-btn');
        const continueSummaryBtn = document.getElementById('continue-summary-btn');

        // --- Modal Functions ---
        function showLoadingModal() {
            loadingModalBg.classList.remove('hidden');
            loadingModalBg.classList.add('flex');
            setTimeout(() => {
                loadingModalBg.classList.remove('opacity-0');
                loadingModal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideLoadingModal() {
            loadingModalBg.classList.add('opacity-0');
            loadingModal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                loadingModalBg.classList.add('hidden');
                loadingModalBg.classList.remove('flex');
            }, 300);
        }

        function showResultModal(text) {
            aiSummaryOutput.textContent = text;
            resultModalBg.classList.remove('hidden');
            resultModalBg.classList.add('flex');
            setTimeout(() => {
                resultModalBg.classList.remove('opacity-0');
                resultModal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideResultModal() {
            resultModalBg.classList.add('opacity-0');
            resultModal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                resultModalBg.classList.add('hidden');
                resultModalBg.classList.remove('flex');
            }, 300);
        }
        
        function showFinalizeModal() {
            const currentName = document.getElementById('shift-leader').value;
            const currentDate = document.getElementById('shift-date').value;
            
            finalizeName.value = currentName || '';
            finalizeDate.value = currentDate || '';
            
            finalizeModalBg.classList.remove('hidden');
            finalizeModalBg.classList.add('flex');
            setTimeout(() => {
                finalizeModalBg.classList.remove('opacity-0');
                finalizeModal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        
        function hideFinalizeModal() {
            finalizeModalBg.classList.add('opacity-0');
            finalizeModal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                finalizeModalBg.classList.add('hidden');
                finalizeModalBg.classList.remove('flex');
            }, 300);
        }

        if (generateSummaryBtn) {
            generateSummaryBtn.addEventListener('click', showFinalizeModal);
        }
        
        if (closeFinalizeBtn) {
            closeFinalizeBtn.addEventListener('click', hideFinalizeModal);
        }
        
        if (continueSummaryBtn) {
            continueSummaryBtn.addEventListener('click', () => {
                const name = finalizeName.value.trim();
                const date = finalizeDate.value;
                
                if (!name || !date) {
                    alert("Please enter both your name and the shift date to continue.");
                    return;
                }
                
                document.getElementById('shift-leader').value = name;
                document.getElementById('shift-date').value = date;
                
                hideFinalizeModal();
                
                handleGenerateSummary();
            });
        }
        
        if (closeResultBtn) closeResultBtn.addEventListener('click', hideResultModal);
        if (closeResultBtn2) closeResultBtn2.addEventListener('click', hideResultModal);
        if (copySummaryBtn) copySummaryBtn.addEventListener('click', () => {
            const textToCopy = aiSummaryOutput.textContent;
            try {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed"; 
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                copySummaryBtn.textContent = 'Copied!';
                setTimeout(() => { copySummaryBtn.textContent = 'Copy to Clipboard'; }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
        });

        async function handleGenerateSummary() {
            showLoadingModal();
            
            const saveSuccess = await saveShiftData(true);
            
            if (!saveSuccess) {
                hideLoadingModal();
                return;
            }
            
            await loadLeaderboard();

            // 1. Scrape data
            const shiftLeader = document.getElementById('shift-leader').value || 'Manager';
            const shiftTimeSelect = document.getElementById('shift-time');
            const shiftTime = shiftTimeSelect.options[shiftTimeSelect.selectedIndex]?.text || 'Shift';
            
            const kpis = {};
            document.querySelectorAll('.target-row').forEach(row => {
                const label = row.querySelector('label').textContent;
                const target = row.querySelector('.target-input').value;
                const actual = row.querySelector('.actual-input').value;
                if(target || actual) {
                    kpis[label] = { target, actual };
                }
            });

            const notes = [];
            document.querySelectorAll('.task-notes').forEach(input => {
                if (input.value.trim() && input.dataset.taskId) {
                    const label = document.querySelector(`label[for="check-${input.dataset.taskId}"]`);
                    if (label) {
                        notes.push({
                            task: label.textContent.trim(),
                            note: input.value.trim()
                        });
                    }
                }
            });

            const otherTasks = {
                "People (Names)": document.getElementById('people-names').value,
                "People (Actual)": document.getElementById('people-actual').value,
                "FUSOC": document.getElementById('tasks-fusoc').value,
                "PR/WR": document.getElementById('tasks-prwr').value,
                "Other Notes": document.getElementById('tasks-others').value,
            };

            const systemPrompt = `
You are an expert McDonald's Shift Manager writing a handover summary.
Your goal is to be professional, clean, and highly organized.
ONLY use plain text.
DO NOT use Markdown (like **, #, or *).
Format lists using a simple dash (-).
DO NOT use asterisks for any formatting.

Here are the metric rules:
- Sales, GC (Guest Count), AC (Average Check): Higher is better.
- Crew Labor: Lower is better.
- RW (Raw Waste): Lower is better.
- OEPE, Order Prep, R2P (Receipt to Present): These are *times*. Lower is better.
- CFS (Customer Feedback Survey): This is a *count*. Higher is better.

Structure your response like this:

Handover Summary: [Manager Name] ([Shift Type])

Shift Highlights
- [One or two key positive takeaways from the shift]

Key Performance (KPIs)
- [Analyze ALL KPIs provided. You MUST include the numbers for every KPI.]
- [ALWAYS use this format: - [Metric] finished [Performance] (Actual: [X] vs Target: [Y]).]
- [Example: - Sales finished strong, finishing Above Target (Actual: 10500 vs Target: 10000).]
- [Example: - Raw Waste (RW) was high, finishing Above Target (Actual: 50 vs Target: 40).]
- [Example: - OEPE was fast, finishing Below Target (Actual: 100s vs Target: 120s).]
- [Example: - Order Prep was slow, finishing Above Target (Actual: 60s vs Target: 50s).]

Critical Focus / Action Items
- [List all tasks that had notes/actions required.]
- [Example: - Outside Restaurant: Drive Thru lane was dirty.]
- [Example: - Production Area: Fryer 3 temp was fluctuating.]

Other Notes
- [Summarize the People, FUSOC, and Other notes.]
`;

            let userQuery = "Please generate a handover summary for the following shift data:\n";
            userQuery += `Manager: ${shiftLeader}, Shift: ${shiftTime}\n`;
            userQuery += "KPIs (Label: {Target, Actual}):\n" + JSON.stringify(kpis, null, 2) + "\n";
            userQuery += "Tasks with Notes:\n" + JSON.stringify(notes, null, 2) + "\n";
            userQuery += "Other Task Notes:\n" + JSON.stringify(otherTasks, null, 2);

            // 3. Call API
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                let response;
                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; 
                    }

                    if (response.status === 429) {
                        console.warn(`API throttled. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        break;
                    }
                }

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error ${response.status}: ${errorBody.error?.message || response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    hideLoadingModal();
                    showResultModal(text);
                } else {
                    throw new Error("No text returned from AI.");
                }
            } catch (error) {
                console.error("Error generating summary:", error);
                hideLoadingModal();
                showResultModal(`Error generating summary: ${error.message}`);
            }
        }

        // --- App Initialization ---
        async function main() {
            try {
                app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase failed to initialize:", e);
                document.body.innerHTML = `<div class="p-8 text-center text-red-600"><strong>Error:</strong> Could not connect to the application database. Please contact support. (Details: ${e.message})</div>`;
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    setTimeout(() => {
                        initShiftPlans();
                        initLeaderboard(); 
                    }, 500);
                }
            });

            try {
                // FIX: The __initial_auth_token provided by the preview environment is for the sandbox project.
                // Since we are connecting directly to 'mcdonalds-san-carlos', that token causes a mismatch error.
                // We skip custom token auth and go straight to Anonymous Auth for your project.
                console.log("Attempting Anonymous Auth to mcdonalds-san-carlos...");
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Authentication failed:", e);
                
                // Log specific advice for common anonymous auth errors
                if (e.code === 'auth/operation-not-allowed') {
                    console.warn("Enable Anonymous Auth in Firebase Console > Authentication > Sign-in method.");
                } else if (e.code === 'auth/unauthorized-domain') {
                    console.warn("Add this domain to Firebase Console > Authentication > Settings > Authorized domains.");
                }

                // Mark auth as ready (even if failed) so UI doesn't hang, but data won't load.
                isAuthReady = true; 
                
                initShiftPlans();
                initLeaderboard(); 
            }
            
            try {
                setupAccordions();
                setupReminders();
                setupTargetCalculations();
                setupAccordionControls(); 
                setupTravelPathSubTabs();
                setupScoreListeners();
            } catch (e) {
                console.error("Error initializing shift management UI:", e);
            }

            const validTabIds = ['leaderboard', 'shift-plans', 'shift-targets', 'pre-shift', 'during-shift', 'travel-path', 'post-shift'];
            let lastTab = localStorage.getItem('activeTab');
            if (!lastTab || !validTabIds.includes(lastTab)) {
                lastTab = 'shift-plans'; // Default to Shift Plans
            }
            showTab(lastTab);

            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    showTab(button.dataset.tab);
                });
            });
            
            const refreshTravelPathBtn = document.getElementById('refresh-travel-path-btn');
            if (refreshTravelPathBtn) {
                refreshTravelPathBtn.addEventListener('click', generateTravelPathReport);
            }

            const refreshTravelPathTodoBtn = document.getElementById('refresh-travel-path-todo-btn');
            if (refreshTravelPathTodoBtn) {
                refreshTravelPathTodoBtn.addEventListener('click', generateTravelPathToDoReport);
            }
        }
        
        window.updateCurrentShiftScore = updateCurrentShiftScore;

        function setupScoreListeners() {
            // Only need to call setupTargetCalculations
        }

        main();

    </script>
</body>
</html>
